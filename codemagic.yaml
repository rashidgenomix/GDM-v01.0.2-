workflows:
  android-release:
    name: Android Release Build (AAB)
    max_build_duration: 60
    environment:
      flutter: stable
      java: 21
      android_signing:
      - germplasmx1
    scripts:
      - name: Get Flutter Dependencies
        script: |
          flutter pub get

      - name: Increment version code
        script: |
          #!/bin/bash
          echo "Incrementing version code..."
          PUBSPEC_FILE="pubspec.yaml"
          VERSION_LINE=$(grep '^version:' $PUBSPEC_FILE)
          
          # Extract current version and code
          VERSION_NAME=$(echo $VERSION_LINE | cut -d'+' -f1 | awk '{print $2}')
          VERSION_CODE=$(echo $VERSION_LINE | cut -d'+' -f2)
          
          # Increment version code
          NEW_VERSION_CODE=$((VERSION_CODE + 1))
          
          # Update pubspec.yaml
          sed -i.bak "s/^version: .*/version: ${VERSION_NAME}+${NEW_VERSION_CODE}/" $PUBSPEC_FILE
          
          echo "Updated version: ${VERSION_NAME}+${NEW_VERSION_CODE}"

      - name: Clean previous build
        script: |
          flutter clean

      - name: Build Android App Bundle
        script: |
          flutter build appbundle --release

    artifacts:
      - build/app/outputs/bundle/release/app-release.aab

    publishing:
      email:
        recipients:
          - rashidrao7@gmail.com
